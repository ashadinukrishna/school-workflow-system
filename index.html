<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Ayathan School Workflow System</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
        }
        .wrapper {
            display: flex;
            width: 100%;
            align-items: stretch;
        }
        #sidebar {
            min-width: 250px;
            max-width: 250px;
            background: #343a40;
            color: #fff;
            transition: all 0.3s;
        }
        #sidebar.active {
            margin-left: -250px;
        }
        #sidebar .sidebar-header {
            padding: 20px;
            background: #212529;
        }
        #sidebar ul.components {
            padding: 20px 0;
            border-bottom: 1px solid #47748b;
        }
        #sidebar ul li a {
            padding: 10px;
            font-size: 1.1em;
            display: block;
            color: #fff;
        }
        #sidebar ul li a:hover {
            color: #343a40;
            background: #fff;
        }
        #content {
            width: 100%;
            padding: 20px;
            min-height: 100vh;
        }
        .login-container {
            max-width: 400px;
            margin: auto;
            margin-top: 100px;
        }
        .card-header {
            background-color: #007bff !important;
            color: white;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .section-content {
            display: none;
        }
        .section-content.active {
            display: block;
        }
        .card {
            margin-bottom: 20px;
        }
        .status-pending {
            color: #ffc107;
            font-weight: bold;
        }
        .status-warning {
            color: #fd7e14;
            font-weight: bold;
            background-color: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .status-approved {
            color: #28a745;
            font-weight: bold;
        }
        .status-rejected {
            color: #dc3545;
            font-weight: bold;
        }
        .timetable-table {
            font-size: 0.9em;
        }
        .timetable-table th,
        .timetable-table td {
            text-align: center;
            vertical-align: middle;
            padding: 8px;
        }
        .period-cell {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .teacher-name {
            font-weight: bold;
            color: #007bff;
        }
        .subject-name {
            font-size: 0.85em;
            color: #6c757d;
        }
        .date-picker-container {
            margin-bottom: 20px;
            text-align: center;
        }
        .date-picker-container input {
            max-width: 200px;
            margin: 0 auto;
        }
        .alert {
            margin-top: 15px;
        }
        .scheme-form {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .table-responsive {
            margin-top: 20px;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .user-info {
            color: #fff;
            margin-left: auto;
        }
        .logout-btn {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginSection" class="container">
        <div class="login-container">
            <div class="card">
                <div class="card-header text-center">
                    <h4><i class="fas fa-school"></i> Ayathan School Login</h4>
                </div>
                <div class="card-body">
                    <form id="loginForm">
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password:</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </form>
                    <div id="loginError" class="alert alert-danger" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appSection" style="display: none;">
        <div class="wrapper">
            <!-- Sidebar -->
            <nav id="sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-school"></i> Ayathan School</h3>
                    <div id="userInfo" class="mt-2">
                        <small id="currentUserName"></small><br>
                        <small id="currentUserRole" class="text-muted"></small>
                    </div>
                </div>
                <ul class="list-unstyled components">
                    <li><a href="#" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#" onclick="showSection('schemes')"><i class="fas fa-book"></i> Schemes</a></li>
                    <li><a href="#" onclick="showSection('lessonPlans')"><i class="fas fa-clipboard-list"></i> Lesson Plans</a></li>
                    <li><a href="#" onclick="showSection('dailyReports')"><i class="fas fa-file-alt"></i> Daily Reports</a></li>
                    <li><a href="#" onclick="showSection('timetable')"><i class="fas fa-calendar"></i> Timetable</a></li>
                    <li id="approvalMenuItem" style="display: none;"><a href="#" onclick="showSection('approval')"><i class="fas fa-check-circle"></i> Approvals</a></li>
                    <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </nav>

            <!-- Page Content -->
            <div id="content">
                <!-- Dashboard Section -->
                <div id="dashboard" class="section-content active">
                    <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h5>Total Schemes</h5>
                                    <h3 id="totalSchemes">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h5>Approved</h5>
                                    <h3 id="approvedSchemes">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h5>Pending</h5>
                                    <h3 id="pendingSchemes">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body">
                                    <h5>Rejected</h5>
                                    <h3 id="rejectedSchemes">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Recent Activity</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentActivity">
                                        <p class="text-muted">Loading recent activity...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schemes Section -->
                <div id="schemes" class="section-content">
                    <h2><i class="fas fa-book"></i> Schemes</h2>
                    
                    <!-- Add New Scheme Form -->
                    <div class="card scheme-form">
                        <div class="card-header">
                            <h5>Submit New Scheme</h5>
                        </div>
                        <div class="card-body">
                            <form id="schemeForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="schemeClass">Class:</label>
                                            <select class="form-control" id="schemeClass" required>
                                                <option value="">Select Class</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="schemeSubject">Subject:</label>
                                            <select class="form-control" id="schemeSubject" required>
                                                <option value="">Select Subject</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="schemeTerm">Term:</label>
                                            <select class="form-control" id="schemeTerm" required>
                                                <option value="">Select Term</option>
                                                <option value="Term1">Term 1</option>
                                                <option value="Term2">Term 2</option>
                                                <option value="Term3">Term 3</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="schemeUnit">Unit:</label>
                                            <input type="text" class="form-control" id="schemeUnit" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="schemeMonth">Month:</label>
                                            <select class="form-control" id="schemeMonth" required>
                                                <option value="">Select Month</option>
                                                <option value="January">January</option>
                                                <option value="February">February</option>
                                                <option value="March">March</option>
                                                <option value="April">April</option>
                                                <option value="May">May</option>
                                                <option value="June">June</option>
                                                <option value="July">July</option>
                                                <option value="August">August</option>
                                                <option value="September">September</option>
                                                <option value="October">October</option>
                                                <option value="November">November</option>
                                                <option value="December">December</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="schemeChapter">Chapter:</label>
                                            <input type="text" class="form-control" id="schemeChapter" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="schemePeriods">Number of Periods:</label>
                                            <input type="number" class="form-control" id="schemePeriods" min="1" required>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Submit Scheme
                                </button>
                            </form>
                            <div id="schemeMessage" class="alert" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Schemes List -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>My Schemes</h5>
                            <!-- Filter Controls -->
                            <div class="row mt-3">
                                <div class="col-md-3">
                                    <select class="form-control form-control-sm" id="schemeFilterClass" onchange="filterSchemes()">
                                        <option value="">All Classes</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control form-control-sm" id="schemeFilterSubject" onchange="filterSchemes()">
                                        <option value="">All Subjects</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control form-control-sm" id="schemeFilterStatus" onchange="filterSchemes()">
                                        <option value="">All Statuses</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Approved">Approved</option>
                                        <option value="Rejected">Rejected</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-sm btn-secondary" onclick="clearSchemeFilters()">Clear Filters</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>ID</th>
                                            <th>Class</th>
                                            <th>Subject</th>
                                            <th>Chapter</th>
                                            <th>Periods</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="schemesTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center">Loading schemes...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lesson Plans Section -->
                <div id="lessonPlans" class="section-content">
                    <h2><i class="fas fa-clipboard-list"></i> Lesson Plans</h2>
                    
                    <!-- For Teachers: Show Approved Schemes for Lesson Plan Preparation -->
                    <div id="approvedSchemesForLessonPlans" class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-tasks"></i> Approved Schemes - Prepare Lesson Plans</h5>
                            <p class="mb-0 text-muted">Click "Prepare Lesson Plans" to create individual lesson plans for each period</p>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Scheme ID</th>
                                            <th>Class</th>
                                            <th>Subject</th>
                                            <th>Chapter</th>
                                            <th>Periods</th>
                                            <th>Approved Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="approvedSchemesTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center">Loading approved schemes...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Lesson Plans List -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>My Lesson Plans</h5>
                            <!-- Filter Controls -->
                            <div class="row mt-3">
                                <div class="col-md-3">
                                    <select class="form-control form-control-sm" id="lessonPlanClassFilter" onchange="filterLessonPlans()">
                                        <option value="">All Classes</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control form-control-sm" id="lessonPlanSubjectFilter" onchange="filterLessonPlans()">
                                        <option value="">All Subjects</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control form-control-sm" id="lessonPlanStatusFilter" onchange="filterLessonPlans()">
                                        <option value="">All Statuses</option>
                                        <option value="Pending Preparation">Pending Preparation</option>
                                        <option value="Pending">Pending Review</option>
                                        <option value="Approved">Approved</option>
                                        <option value="Needs Rework">Needs Rework</option>
                                        <option value="Rejected">Rejected</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-sm btn-secondary" onclick="clearLessonPlanFilters()">Clear Filters</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>LP ID</th>
                                            <th>Scheme ID</th>
                                            <th>Class</th>
                                            <th>Subject</th>
                                            <th>Chapter</th>
                                            <th>Period</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lessonPlansTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center">Loading lesson plans...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Reports Section -->
                <div id="dailyReports" class="section-content">
                    <h2><i class="fas fa-file-alt"></i> Daily Reports</h2>
                    
                    <!-- Today's Timetable Info -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6><i class="fas fa-calendar-day"></i> Today's Schedule</h6>
                        </div>
                        <div class="card-body">
                            <div id="todayTimetableInfo">
                                <p class="text-muted">Loading today's schedule...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Daily Report Form -->
                    <div class="card">
                        <div class="card-header">
                            <h5>Submit Daily Report</h5>
                        </div>
                        <div class="card-body">
                            <form id="dailyReportForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="reportDate">Date:</label>
                                            <input type="date" class="form-control" id="reportDate" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="reportPeriod">Period (from your timetable):</label>
                                            <select class="form-control" id="reportPeriod" required onchange="updateClassAndSubjectFromTimetable()">
                                                <option value="">Select Period</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="reportClass">Class:</label>
                                            <input type="text" class="form-control" id="reportClass" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="reportSubject">Subject:</label>
                                            <input type="text" class="form-control" id="reportSubject" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="reportLessonPlan">Lesson Plan:</label>
                                            <select class="form-control" id="reportLessonPlan" required onchange="autoFillLessonPlanDetails()">
                                                <option value="">First select period</option>
                                                <option value="no-plan">No Plan (Direct Teaching)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="reportChapter">Chapter/Topic:</label>
                                            <input type="text" class="form-control" id="reportChapter" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="reportObjectives">Objectives Delivered:</label>
                                    <textarea class="form-control" id="reportObjectives" rows="3" required></textarea>
                                    <small class="form-text text-muted">Auto-filled from lesson plan (editable)</small>
                                </div>
                                <div class="form-group">
                                    <label for="reportActivities">Activities Done:</label>
                                    <textarea class="form-control" id="reportActivities" rows="3" required></textarea>
                                    <small class="form-text text-muted">Auto-filled from lesson plan (editable)</small>
                                </div>
                                <div class="form-group">
                                    <label for="reportCompleted">Was Lesson Completed?</label>
                                    <select class="form-control" id="reportCompleted" required>
                                        <option value="">Select Status</option>
                                        <option value="Yes">Yes - Fully Completed</option>
                                        <option value="Partial">Partially Completed</option>
                                        <option value="No">No - Not Completed</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="reportNotes">Additional Notes:</label>
                                    <textarea class="form-control" id="reportNotes" rows="2"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Submit Report
                                </button>
                            </form>
                            <div id="reportMessage" class="alert" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Daily Reports List -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>My Daily Reports</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Class</th>
                                            <th>Period</th>
                                            <th>Chapter</th>
                                            <th>Completed</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dailyReportsTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center">Loading daily reports...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timetable Section -->
                <div id="timetable" class="section-content">
                    <h2><i class="fas fa-calendar"></i> <span id="timetablePageTitle">My Timetable</span></h2>
                    
                    <div class="date-picker-container">
                        <label for="timetableDate"><strong>Select Date:</strong></label>
                        <input type="date" class="form-control" id="timetableDate" onchange="loadTimetable()">
                    </div>

                    <!-- Principal/Admin View - Filters -->
                    <div id="principalTimetableFilters" class="card mb-3" style="display: none;">
                        <div class="card-header">
                            <h6><i class="fas fa-filter"></i> Timetable Filters</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <select class="form-control form-control-sm" id="timetableTeacherFilter" onchange="loadTimetable()">
                                        <option value="">All Teachers</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-control form-control-sm" id="timetableClassFilter" onchange="loadTimetable()">
                                        <option value="">All Classes</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-sm btn-secondary" onclick="clearTimetableFilters()">Clear Filters</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 id="timetableTitle">Today's Schedule</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered timetable-table">
                                    <thead class="thead-dark" id="timetableHeader">
                                        <tr>
                                            <th>Period</th>
                                            <th>Time</th>
                                            <th>Class</th>
                                            <th>Subject</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="timetableBody">
                                        <tr>
                                            <td colspan="5" class="text-center">Loading timetable...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Approval Section (Headmaster only) -->
                <div id="approval" class="section-content">
                    <h2><i class="fas fa-check-circle"></i> Approvals</h2>
                    
                    <!-- Approval Tabs -->
                    <ul class="nav nav-tabs" id="approvalTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="scheme-approvals-tab" data-toggle="tab" href="#scheme-approvals" role="tab">
                                <i class="fas fa-book"></i> Scheme Approvals
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="lesson-plan-approvals-tab" data-toggle="tab" href="#lesson-plan-approvals" role="tab">
                                <i class="fas fa-clipboard-list"></i> Lesson Plan Approvals
                            </a>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="approvalTabContent">
                        <!-- Scheme Approvals Tab -->
                        <div class="tab-pane fade show active" id="scheme-approvals" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Pending Scheme Approvals</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>ID</th>
                                                    <th>Teacher</th>
                                                    <th>Month</th>
                                                    <th>Class</th>
                                                    <th>Subject</th>
                                                    <th>Chapter</th>
                                                    <th>Periods</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="approvalTableBody">
                                                <tr>
                                                    <td colspan="9" class="text-center">Loading pending approvals...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lesson Plan Approvals Tab -->
                        <div class="tab-pane fade" id="lesson-plan-approvals" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Pending Lesson Plan Approvals</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>LP ID</th>
                                                    <th>Scheme ID</th>
                                                    <th>Teacher</th>
                                                    <th>Month</th>
                                                    <th>Class</th>
                                                    <th>Subject</th>
                                                    <th>Chapter</th>
                                                    <th>Period</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="lessonPlanApprovalTableBody">
                                                <tr>
                                                    <td colspan="9" class="text-center">Loading pending lesson plan approvals...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Scheme Details Modal -->
    <div class="modal fade" id="schemeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Scheme Details</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="schemeModalBody">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Approve/Reject Scheme</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="approvalSchemeDetails"></div>
                    <div class="form-group mt-3">
                        <label for="rejectionReason">Reason (for rejection):</label>
                        <textarea class="form-control" id="rejectionReason" rows="3" placeholder="Enter reason if rejecting..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="approveScheme()">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button type="button" class="btn btn-danger" onclick="rejectScheme()">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Lesson Plan Creation Modal -->
    <div class="modal fade" id="bulkLessonPlanModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Prepare Lesson Plans for Scheme</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="bulkLessonPlanDetails"></div>
                    <form id="bulkLessonPlanForm">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Sub-Chapter/Topic</th>
                                        <th>Learning Objectives</th>
                                        <th>Planned Activities</th>
                                    </tr>
                                </thead>
                                <tbody id="bulkLessonPlanTableBody">
                                    <!-- Rows will be generated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="submitBulkLessonPlans()">
                        <i class="fas fa-check"></i> Create All Lesson Plans
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lesson Plan Completion Modal -->
    <div class="modal fade" id="lessonPlanCompletionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Complete Lesson Plan</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="completionLessonPlanDetails"></div>
                    <form id="lessonPlanCompletionForm">
                        <div class="form-group">
                            <label for="completionPeriod">Period Number:</label>
                            <select class="form-control" id="completionPeriod" required>
                                <option value="">Select Period</option>
                                <option value="1">Period 1</option>
                                <option value="2">Period 2</option>
                                <option value="3">Period 3</option>
                                <option value="4">Period 4</option>
                                <option value="5">Period 5</option>
                                <option value="6">Period 6</option>
                                <option value="7">Period 7</option>
                                <option value="8">Period 8</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="completionObjectives">Learning Objectives:</label>
                            <textarea class="form-control" id="completionObjectives" rows="4" required 
                                placeholder="List the specific learning objectives for this lesson..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="completionActivities">Planned Activities:</label>
                            <textarea class="form-control" id="completionActivities" rows="4" required 
                                placeholder="Describe the activities you will conduct in this lesson..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="submitLessonPlanCompletion()">
                        <i class="fas fa-check"></i> Complete Lesson Plan
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lesson Plan View Modal -->
    <div class="modal fade" id="lessonPlanViewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Lesson Plan Details</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="viewLessonPlanDetails"></div>
                </div>
                <div class="modal-footer" id="lessonPlanViewActions">
                    <!-- Actions will be populated based on role and status -->
                </div>
            </div>
        </div>
    </div>

    <!-- Lesson Plan Approval Modal -->
    <div class="modal fade" id="lessonPlanApprovalModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Lesson Plan Review & Action</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="approvalLessonPlanDetails"></div>
                    
                    <!-- Objectives and Activities Display -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Learning Objectives:</strong></label>
                                <div id="lessonPlanObjectives" class="border p-3 bg-light" style="min-height: 100px; border-radius: 5px;">
                                    Loading objectives...
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Planned Activities:</strong></label>
                                <div id="lessonPlanActivities" class="border p-3 bg-light" style="min-height: 100px; border-radius: 5px;">
                                    Loading activities...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group mt-3">
                        <label for="lessonPlanActionReason">Reason/Comments:</label>
                        <textarea class="form-control" id="lessonPlanActionReason" rows="3" placeholder="Enter reason for rejection or comments for rework..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="approveLessonPlanFromModal()">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button type="button" class="btn btn-warning" onclick="needsReworkLessonPlan()">
                        <i class="fas fa-edit"></i> Needs Rework
                    </button>
                    <button type="button" class="btn btn-danger" onclick="rejectLessonPlanFromModal()">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let currentUser = null;
        let currentSchemeId = null;
        let currentLessonPlanId = null;
        let currentCompletionLessonPlanId = null;
        let todayTimetableData = [];
        let lessonPlansData = [];
        
        // API Configuration - REPLACE WITH YOUR DEPLOYED GOOGLE APPS SCRIPT URL
        const API_URL = 'https://script.google.com/a/macros/ayathanschool.com/s/AKfycbx7leQt0KYs0QrmDldbQb7LSchrPRz8XpaaZIER4w1SY0YmY4ddP6HqbVB-uEYvlBHLqw/exec';

        // Initialize the application
        $(document).ready(function() {
            setupEventListeners();
            setTodayDate();
            // Set default login for testing
            $('#email').val('admin@ayathanschool.com');
            $('#password').val('admin123');
        });

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            $('#timetableDate').val(today);
            $('#reportDate').val(today);
        }

        function setupEventListeners() {
            $('#loginForm').on('submit', handleLogin);
            $('#schemeForm').on('submit', handleSchemeSubmission);
            $('#lessonPlanForm').on('submit', handleLessonPlanSubmission);
            $('#dailyReportForm').on('submit', handleDailyReportSubmission);
            
            // Scheme filter event listeners
            $('#schemeClassFilter, #schemeSubjectFilter, #schemeStatusFilter').on('change', filterSchemes);
            
            // Lesson plan filter event listeners  
            $('#lessonPlanClassFilter, #lessonPlanSubjectFilter, #lessonPlanStatusFilter').on('change', filterLessonPlans);
        }

        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = $('#email').val();
            const password = $('#password').val();
            
            try {
                const response = await fetch(`${API_URL}?action=login&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.user;
                    showApp();
                    loadDashboard();
                } else {
                    showError('loginError', result.message || 'Invalid credentials');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('loginError', 'Login failed. Please try again.');
            }
        }

        function showApp() {
            $('#loginSection').hide();
            $('#appSection').show();
            
            // Update user info
            $('#currentUserName').text(currentUser.name);
            $('#currentUserRole').text(currentUser.role);
            
            // Show/hide menu items and forms based on role
            if (currentUser.role === 'Headmaster') {
                $('#approvalMenuItem').show();
                $('#lessonPlanFormSection').hide(); // Hide lesson plan form for Headmaster
                // Timetable view for Headmaster (individual teacher view)
                $('#timetablePageTitle').text('Teacher Timetables');
                $('#principalTimetableFilters').show();
                setupTimetableForRole('headmaster');
            } else if (currentUser.role === 'Class Teacher') {
                $('#approvalMenuItem').hide(); // Class teachers can't approve
                $('#lessonPlanFormSection').show(); // Show lesson plan form for Class Teachers
                // Timetable view for Class Teacher (class-specific view)
                $('#timetablePageTitle').text('Class Timetable');
                setupTimetableForRole('teacher');
            } else {
                $('#lessonPlanFormSection').show(); // Show lesson plan form for Teachers
                // Timetable view for Teachers (personal schedule)
                $('#timetablePageTitle').text('My Timetable');
                setupTimetableForRole('teacher');
            }
            
            // Load user-specific data
            loadUserClasses();
            loadUserSubjects();
            loadLessonPlanUserData();
        }

        function logout() {
            currentUser = null;
            $('#appSection').hide();
            $('#loginSection').show();
            $('#loginForm')[0].reset();
            showSection('dashboard');
        }

        // Navigation functions
        function showSection(sectionName) {
            $('.section-content').removeClass('active');
            $(`#${sectionName}`).addClass('active');
            
            // Load section-specific data
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'schemes':
                    loadSchemes();
                    break;
                case 'lessonPlans':
                    loadLessonPlans();
                    break;
                case 'dailyReports':
                    loadDailyReports();
                    loadTodayTimetableForReports();
                    break;
                case 'timetable':
                    // Ensure date is set before loading timetable
                    if (!$('#timetableDate').val()) {
                        const today = new Date().toISOString().split('T')[0];
                        $('#timetableDate').val(today);
                    }
                    loadTimetable();
                    break;
                case 'approval':
                    loadPendingApprovals();
                    loadPendingLessonPlanApprovals();
                    break;
            }
        }

        // Dashboard functions
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_URL}?action=getDashboard&userEmail=${encodeURIComponent(currentUser.email)}`);
                const result = await response.json();
                
                if (result.success) {
                    updateDashboardStats(result.data);
                } else {
                    console.error('Failed to load dashboard:', result.message);
                }
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }

        function updateDashboardStats(data) {
            $('#totalSchemes').text(data.totalSchemes || 0);
            $('#approvedSchemes').text(data.approvedSchemes || 0);
            $('#pendingSchemes').text(data.pendingSchemes || 0);
            $('#rejectedSchemes').text(data.rejectedSchemes || 0);
            
            // Update recent activity
            if (data.recentActivity && data.recentActivity.length > 0) {
                let activityHtml = '';
                data.recentActivity.forEach(activity => {
                    activityHtml += `<p><strong>${activity.date}</strong>: ${activity.description}</p>`;
                });
                $('#recentActivity').html(activityHtml);
            } else {
                $('#recentActivity').html('<p class="text-muted">No recent activity</p>');
            }
        }

        // Scheme functions
        async function handleSchemeSubmission(e) {
            e.preventDefault();
            
            const schemeData = {
                teacherName: currentUser.name,
                teacherEmail: currentUser.email,
                class: $('#schemeClass').val(),
                subject: $('#schemeSubject').val(),
                term: $('#schemeTerm').val(),
                unit: $('#schemeUnit').val(),
                month: $('#schemeMonth').val(),
                chapter: $('#schemeChapter').val(),
                periods: $('#schemePeriods').val()
            };
            
            try {
                // Convert to GET request to avoid CORS issues
                const params = new URLSearchParams({
                    action: 'addScheme',
                    ...schemeData
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    showMessage('schemeMessage', 'Scheme submitted successfully!', 'success');
                    $('#schemeForm')[0].reset();
                    loadSchemes();
                } else {
                    showMessage('schemeMessage', result.message || 'Failed to submit scheme', 'danger');
                }
            } catch (error) {
                console.error('Scheme submission error:', error);
                showMessage('schemeMessage', 'Failed to submit scheme. Please try again.', 'danger');
            }
        }

        // Lesson Plan submission function
        async function handleLessonPlanSubmission(e) {
            e.preventDefault();
            
            const lessonPlanData = {
                teacherName: currentUser.name,
                teacher: currentUser.name,
                schemeId: $('#lpSchemeId').val(),
                class: $('#lpClass').val(),
                subject: $('#lpSubject').val(),
                chapter: $('#lpChapter').val(),
                period: $('#lpPeriod').val(),
                objectives: $('#lpObjectives').val(),
                activities: $('#lpActivities').val()
            };
            
            try {
                // Convert to GET request to avoid CORS issues
                const params = new URLSearchParams({
                    action: 'addLessonPlan',
                    ...lessonPlanData
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    showMessage('lessonPlanMessage', 'Lesson plan submitted successfully!', 'success');
                    $('#lessonPlanForm')[0].reset();
                    loadLessonPlans();
                } else {
                    showMessage('lessonPlanMessage', result.message || 'Failed to submit lesson plan', 'danger');
                }
            } catch (error) {
                console.error('Lesson plan submission error:', error);
                showMessage('lessonPlanMessage', 'Failed to submit lesson plan. Please try again.', 'danger');
            }
        }

        async function loadSchemes() {
            try {
                const response = await fetch(`${API_URL}?action=getSchemes&userEmail=${encodeURIComponent(currentUser.email)}&userRole=${encodeURIComponent(currentUser.role)}`);
                const result = await response.json();
                
                if (result.success) {
                    displaySchemes(result.data);
                } else {
                    console.error('Failed to load schemes:', result.message);
                }
            } catch (error) {
                console.error('Schemes loading error:', error);
            }
        }

        function displaySchemes(schemes) {
            const tbody = $('#schemesTableBody');
            tbody.empty();
            
            // Store all schemes for filtering
            window.allSchemes = schemes;
            
            // Populate filter dropdowns
            populateSchemeFilters(schemes);
            
            if (schemes.length === 0) {
                tbody.append('<tr><td colspan="8" class="text-center">No schemes found</td></tr>');
                return;
            }
            
            schemes.forEach(scheme => {
                const statusClass = scheme.status === 'Approved' ? 'status-approved' : 
                                   scheme.status === 'Rejected' ? 'status-rejected' : 'status-pending';
                
                const row = `
                    <tr>
                        <td>${scheme.date || ''}</td>
                        <td>${scheme.schemeId || ''}</td>
                        <td>${scheme.class || ''}</td>
                        <td>${scheme.subject || ''}</td>
                        <td>${scheme.chapter || ''}</td>
                        <td>${scheme.periods || ''}</td>
                        <td class="${statusClass}">${scheme.status || 'Pending'}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewSchemeDetails('${scheme.schemeId}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function populateSchemeFilters(schemes) {
            const classFilter = $('#schemeFilterClass');
            const subjectFilter = $('#schemeFilterSubject');
            
            // Get unique values
            const classes = [...new Set(schemes.map(s => s.class).filter(Boolean))];
            const subjects = [...new Set(schemes.map(s => s.subject).filter(Boolean))];
            
            // Populate class filter
            classFilter.find('option:not(:first)').remove();
            classes.forEach(className => {
                classFilter.append(`<option value="${className}">${className}</option>`);
            });
            
            // Populate subject filter
            subjectFilter.find('option:not(:first)').remove();
            subjects.forEach(subject => {
                subjectFilter.append(`<option value="${subject}">${subject}</option>`);
            });
        }

        function filterSchemes() {
            const classFilter = $('#schemeFilterClass').val();
            const subjectFilter = $('#schemeFilterSubject').val();
            const statusFilter = $('#schemeFilterStatus').val();
            
            let filteredSchemes = window.allSchemes || [];
            
            if (classFilter) {
                filteredSchemes = filteredSchemes.filter(s => s.class === classFilter);
            }
            if (subjectFilter) {
                filteredSchemes = filteredSchemes.filter(s => s.subject === subjectFilter);
            }
            if (statusFilter) {
                filteredSchemes = filteredSchemes.filter(s => s.status === statusFilter);
            }
            
            // Re-display filtered schemes
            const tbody = $('#schemesTableBody');
            tbody.empty();
            
            if (filteredSchemes.length === 0) {
                tbody.append('<tr><td colspan="8" class="text-center">No schemes match the filters</td></tr>');
                return;
            }
            
            filteredSchemes.forEach(scheme => {
                const statusClass = scheme.status === 'Approved' ? 'status-approved' : 
                                   scheme.status === 'Rejected' ? 'status-rejected' : 'status-pending';
                
                const row = `
                    <tr>
                        <td>${scheme.date || ''}</td>
                        <td>${scheme.schemeId || ''}</td>
                        <td>${scheme.class || ''}</td>
                        <td>${scheme.subject || ''}</td>
                        <td>${scheme.chapter || ''}</td>
                        <td>${scheme.periods || ''}</td>
                        <td class="${statusClass}">${scheme.status || 'Pending'}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewSchemeDetails('${scheme.schemeId}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function clearSchemeFilters() {
            $('#schemeFilterClass').val('');
            $('#schemeFilterSubject').val('');
            $('#schemeFilterStatus').val('');
            filterSchemes();
        }

        // Lesson Plans functions
        async function loadLessonPlans() {
            try {
                const response = await fetch(`${API_URL}?action=getLessonPlans&userEmail=${encodeURIComponent(currentUser.email)}`);
                const result = await response.json();
                
                if (result.success) {
                    displayLessonPlans(result.data);
                    loadApprovedSchemesForLessonPlans(); // Load approved schemes for lesson plan preparation
                } else {
                    console.error('Failed to load lesson plans:', result.message);
                }
            } catch (error) {
                console.error('Lesson plans loading error:', error);
            }
        }

        async function loadApprovedSchemesForLessonPlans() {
            try {
                const response = await fetch(`${API_URL}?action=getApprovedSchemes&userEmail=${encodeURIComponent(currentUser.email)}`);
                const result = await response.json();
                
                if (result.success) {
                    displayApprovedSchemesForLessonPlans(result.data);
                } else {
                    console.error('Failed to load approved schemes:', result.message);
                }
            } catch (error) {
                console.error('Approved schemes loading error:', error);
            }
        }

        function displayApprovedSchemesForLessonPlans(schemes) {
            const tbody = $('#approvedSchemesTableBody');
            tbody.empty();
            
            if (schemes.length === 0) {
                tbody.append('<tr><td colspan="7" class="text-center">No approved schemes available for lesson plan preparation</td></tr>');
                return;
            }
            
            schemes.forEach(scheme => {
                const row = `
                    <tr>
                        <td>${scheme.schemeId || ''}</td>
                        <td>${scheme.class || ''}</td>
                        <td>${scheme.subject || ''}</td>
                        <td>${scheme.chapter || ''}</td>
                        <td>${scheme.periods || ''}</td>
                        <td>${scheme.approvedDate || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="prepareLessonPlans('${scheme.schemeId}', '${scheme.class}', '${scheme.subject}', '${scheme.chapter}', ${scheme.periods})">
                                <i class="fas fa-plus"></i> Prepare Lesson Plans
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function prepareLessonPlans(schemeId, className, subject, chapter, periods) {
            // Store scheme data for later use
            window.currentSchemeForLessonPlans = {
                schemeId: schemeId,
                class: className,
                subject: subject,
                chapter: chapter,
                periods: periods
            };
            
            // Show details in modal
            $('#bulkLessonPlanDetails').html(`
                <div class="alert alert-info">
                    <h6>Creating Lesson Plans for:</h6>
                    <p><strong>Scheme ID:</strong> ${schemeId}</p>
                    <p><strong>Class:</strong> ${className} | <strong>Subject:</strong> ${subject}</p>
                    <p><strong>Main Chapter:</strong> ${chapter}</p>
                    <p><strong>Number of Periods:</strong> ${periods}</p>
                </div>
            `);
            
            // Generate table rows for each period
            const tableBody = $('#bulkLessonPlanTableBody');
            tableBody.empty();
            
            for (let i = 1; i <= periods; i++) {
                const row = `
                    <tr>
                        <td><strong>Period ${i}</strong></td>
                        <td>
                            <input type="text" class="form-control" id="subChapter_${i}" 
                                   placeholder="Sub-chapter or specific topic for period ${i}" required>
                        </td>
                        <td>
                            <textarea class="form-control" id="objectives_${i}" rows="3" 
                                      placeholder="Learning objectives for period ${i}..." required></textarea>
                        </td>
                        <td>
                            <textarea class="form-control" id="activities_${i}" rows="3" 
                                      placeholder="Planned activities for period ${i}..." required></textarea>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
            }
            
            // Store scheme details for submission
            window.currentSchemeForLessonPlans = {
                schemeId: schemeId,
                class: className,
                subject: subject,
                chapter: chapter,
                periods: periods
            };
            
            // Show the modal
            $('#bulkLessonPlanModal').modal('show');
        }

        async function submitBulkLessonPlans() {
            const schemeData = window.currentSchemeForLessonPlans;
            if (!schemeData) return;
            
            const lessonPlans = [];
            
            // Collect data from all periods
            for (let i = 1; i <= schemeData.periods; i++) {
                const subChapter = $(`#subChapter_${i}`).val();
                const objectives = $(`#objectives_${i}`).val();
                const activities = $(`#activities_${i}`).val();
                
                if (!subChapter.trim() || !objectives.trim() || !activities.trim()) {
                    alert(`Please fill all fields for Period ${i}`);
                    return;
                }
                
                lessonPlans.push({
                    schemeId: schemeData.schemeId,
                    class: schemeData.class,
                    subject: schemeData.subject,
                    mainChapter: schemeData.chapter,
                    subChapter: subChapter,
                    period: i,
                    objectives: objectives,
                    activities: activities,
                    teacher: currentUser.name
                });
            }
            
            try {
                const params = new URLSearchParams({
                    action: 'createBulkLessonPlans',
                    lessonPlans: JSON.stringify(lessonPlans)
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    $('#bulkLessonPlanModal').modal('hide');
                    alert(`Successfully created ${lessonPlans.length} lesson plans for review!`);
                    loadLessonPlans(); // Refresh the lesson plans list
                } else {
                    alert('Failed to create lesson plans: ' + result.message);
                }
            } catch (error) {
                console.error('Bulk lesson plan creation error:', error);
                alert('Failed to create lesson plans. Please try again.');
            }
        }

        function displayLessonPlans(lessonPlans) {
            const tbody = $('#lessonPlansTableBody');
            tbody.empty();
            
            // Store lesson plans data globally for reference
            lessonPlansData = lessonPlans;
            
            if (lessonPlans.length === 0) {
                tbody.append('<tr><td colspan="8" class="text-center">No lesson plans found</td></tr>');
                return;
            }
            
            // Populate filter dropdowns
            populateLessonPlanFilters(lessonPlans);
            
            lessonPlans.forEach(lp => {
                const statusClass = lp.Status === 'Approved' ? 'status-approved' : 
                                   lp.Status === 'Rejected' ? 'status-rejected' : 
                                   lp.Status === 'Need Correction' ? 'status-rejected' :
                                   lp.Status === 'Needs Rework' ? 'status-warning' :
                                   lp.Status === 'Pending Preparation' ? 'status-warning' : 'status-pending';
                
                let actionButton;
                
                // Different actions based on user role and lesson plan status
                if (currentUser.role === 'Headmaster') {
                    // Headmaster always views first, then can take action if pending
                    if (lp.Status === 'Pending') {
                        actionButton = `
                            <button class="btn btn-sm btn-info" onclick="viewLessonPlanForApproval('${lp.LPID}')">
                                <i class="fas fa-eye"></i> View & Approve
                            </button>
                        `;
                    } else {
                        actionButton = `<button class="btn btn-sm btn-info" onclick="viewLessonPlanDetails('${lp.LPID}')">
                            <i class="fas fa-eye"></i> View
                        </button>`;
                    }
                } else {
                    // Teachers can complete lesson plans or view them
                    if (lp.Status === 'Pending Preparation') {
                        actionButton = `<button class="btn btn-sm btn-warning" onclick="openLessonPlanCompletionModal('${lp.LPID}', '${lp.ChapterName}', '${lp.Class}', '${lp.Subject}', '${lp.Period || ''}')">
                            <i class="fas fa-edit"></i> Complete
                        </button>`;
                    } else if (lp.Status === 'Needs Rework') {
                        actionButton = `<button class="btn btn-sm btn-warning" onclick="openLessonPlanCompletionModal('${lp.LPID}', '${lp.ChapterName}', '${lp.Class}', '${lp.Subject}', '${lp.Period || ''}')">
                            <i class="fas fa-edit"></i> Rework
                        </button>`;
                    } else {
                        actionButton = `<button class="btn btn-sm btn-info" onclick="viewLessonPlanDetails('${lp.LPID}')">
                            <i class="fas fa-eye"></i> View
                        </button>`;
                    }
                }
                
                // Display period properly
                const periodDisplay = lp.Period ? `Period ${lp.Period}` : 'Not Set';
                
                const row = `
                    <tr>
                        <td>${lp.LPID || ''}</td>
                        <td>${lp.SchemeID || ''}</td>
                        <td>${lp.Class || ''}</td>
                        <td>${lp.Subject || ''}</td>
                        <td>${lp.ChapterName || ''}</td>
                        <td>${periodDisplay}</td>
                        <td class="${statusClass}">${lp.Status || 'Unknown'}</td>
                        <td>${actionButton}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        // Lesson Plan Filter Functions
        function populateLessonPlanFilters(lessonPlans) {
            // Get unique values for dropdowns
            const classes = [...new Set(lessonPlans.map(lp => lp.Class).filter(c => c))];
            const subjects = [...new Set(lessonPlans.map(lp => lp.Subject).filter(s => s))];
            const statuses = [...new Set(lessonPlans.map(lp => lp.Status).filter(s => s))];
            
            // Populate class filter
            const classFilter = $('#lessonPlanClassFilter');
            classFilter.empty().append('<option value="">All Classes</option>');
            classes.sort().forEach(cls => {
                classFilter.append(`<option value="${cls}">${cls}</option>`);
            });
            
            // Populate subject filter
            const subjectFilter = $('#lessonPlanSubjectFilter');
            subjectFilter.empty().append('<option value="">All Subjects</option>');
            subjects.sort().forEach(sub => {
                subjectFilter.append(`<option value="${sub}">${sub}</option>`);
            });
            
            // Populate status filter
            const statusFilter = $('#lessonPlanStatusFilter');
            statusFilter.empty().append('<option value="">All Statuses</option>');
            statuses.sort().forEach(status => {
                statusFilter.append(`<option value="${status}">${status}</option>`);
            });
        }

        function filterLessonPlans() {
            if (!lessonPlansData) return;
            
            const classFilter = $('#lessonPlanClassFilter').val();
            const subjectFilter = $('#lessonPlanSubjectFilter').val();
            const statusFilter = $('#lessonPlanStatusFilter').val();
            
            let filteredData = lessonPlansData;
            
            if (classFilter) {
                filteredData = filteredData.filter(lp => lp.Class === classFilter);
            }
            
            if (subjectFilter) {
                filteredData = filteredData.filter(lp => lp.Subject === subjectFilter);
            }
            
            if (statusFilter) {
                filteredData = filteredData.filter(lp => lp.Status === statusFilter);
            }
            
            displayFilteredLessonPlans(filteredData);
        }

        function displayFilteredLessonPlans(lessonPlans) {
            const tbody = $('#lessonPlansTableBody');
            tbody.empty();
            
            if (lessonPlans.length === 0) {
                tbody.append('<tr><td colspan="8" class="text-center">No lesson plans match the current filters</td></tr>');
                return;
            }
            
            lessonPlans.forEach(lp => {
                const statusClass = lp.Status === 'Approved' ? 'status-approved' : 
                                   lp.Status === 'Rejected' ? 'status-rejected' : 
                                   lp.Status === 'Need Correction' ? 'status-rejected' :
                                   lp.Status === 'Needs Rework' ? 'status-warning' :
                                   lp.Status === 'Pending Preparation' ? 'status-warning' : 'status-pending';
                
                let actionButton;
                
                // Different actions based on user role and lesson plan status
                if (currentUser.role === 'Headmaster') {
                    // Headmaster always views first, then can take action if pending
                    if (lp.Status === 'Pending') {
                        actionButton = `
                            <button class="btn btn-sm btn-info" onclick="viewLessonPlanForApproval('${lp.LPID}')">
                                <i class="fas fa-eye"></i> View & Approve
                            </button>
                        `;
                    } else {
                        actionButton = `<button class="btn btn-sm btn-info" onclick="viewLessonPlanDetails('${lp.LPID}')">
                            <i class="fas fa-eye"></i> View
                        </button>`;
                    }
                } else {
                    // Teachers can complete lesson plans or view them
                    if (lp.Status === 'Pending Preparation') {
                        actionButton = `<button class="btn btn-sm btn-warning" onclick="openLessonPlanCompletionModal('${lp.LPID}', '${lp.ChapterName}', '${lp.Class}', '${lp.Subject}', '${lp.Period || ''}')">
                            <i class="fas fa-edit"></i> Complete
                        </button>`;
                    } else if (lp.Status === 'Needs Rework') {
                        actionButton = `<button class="btn btn-sm btn-warning" onclick="openLessonPlanCompletionModal('${lp.LPID}', '${lp.ChapterName}', '${lp.Class}', '${lp.Subject}', '${lp.Period || ''}')">
                            <i class="fas fa-edit"></i> Rework
                        </button>`;
                    } else {
                        actionButton = `<button class="btn btn-sm btn-info" onclick="viewLessonPlanDetails('${lp.LPID}')">
                            <i class="fas fa-eye"></i> View
                        </button>`;
                    }
                }
                
                // Display period properly
                const periodDisplay = lp.Period ? `Period ${lp.Period}` : 'Not Set';
                
                const row = `
                    <tr>
                        <td>${lp.LPID || ''}</td>
                        <td>${lp.SchemeID || ''}</td>
                        <td>${lp.Class || ''}</td>
                        <td>${lp.Subject || ''}</td>
                        <td>${lp.ChapterName || ''}</td>
                        <td>${periodDisplay}</td>
                        <td class="${statusClass}">${lp.Status || 'Unknown'}</td>
                        <td>${actionButton}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function clearLessonPlanFilters() {
            $('#lessonPlanClassFilter').val('');
            $('#lessonPlanSubjectFilter').val('');
            $('#lessonPlanStatusFilter').val('');
            
            if (lessonPlansData) {
                displayFilteredLessonPlans(lessonPlansData);
            }
        }

        // Daily Reports functions
        async function handleDailyReportSubmission(e) {
            e.preventDefault();
            
            const reportData = {
                teacherName: currentUser.name,
                teacherEmail: currentUser.email,
                date: $('#reportDate').val(),
                class: $('#reportClass').val(),
                period: $('#reportPeriod').val(),
                lessonPlanId: $('#reportLessonPlan').val(),
                objectives: $('#reportObjectives').val(),
                activities: $('#reportActivities').val(),
                completed: $('#reportCompleted').val(),
                notes: $('#reportNotes').val()
            };
            
            try {
                // Convert to GET request to avoid CORS issues
                const params = new URLSearchParams({
                    action: 'addDailyReport',
                    ...reportData
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    showMessage('reportMessage', 'Daily report submitted successfully!', 'success');
                    $('#dailyReportForm')[0].reset();
                    loadDailyReports();
                } else {
                    showMessage('reportMessage', result.message || 'Failed to submit report', 'danger');
                }
            } catch (error) {
                console.error('Daily report submission error:', error);
                showMessage('reportMessage', 'Failed to submit report. Please try again.', 'danger');
            }
        }

        async function loadDailyReports() {
            try {
                const response = await fetch(`${API_URL}?action=getDailyReports&userEmail=${encodeURIComponent(currentUser.email)}`);
                const result = await response.json();
                
                if (result.success) {
                    displayDailyReports(result.data);
                } else {
                    console.error('Failed to load daily reports:', result.message);
                }
            } catch (error) {
                console.error('Daily reports loading error:', error);
            }
        }

        function displayDailyReports(reports) {
            const tbody = $('#dailyReportsTableBody');
            tbody.empty();
            
            if (reports.length === 0) {
                tbody.append('<tr><td colspan="6" class="text-center">No daily reports found</td></tr>');
                return;
            }
            
            reports.forEach(report => {
                const row = `
                    <tr>
                        <td>${report.date}</td>
                        <td>${report.class}</td>
                        <td>${report.period}</td>
                        <td>${report.chapter}</td>
                        <td>${report.completed}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewReportDetails('${report.reportId}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        // Timetable functions
        function setupTimetableForRole(role) {
            const header = $('#timetableHeader tr');
            
            if (role === 'headmaster') {
                // Headmaster sees all classes with teacher info and filters
                header.html(`
                    <th>Period</th>
                    <th>Time</th>
                    <th>Class</th>
                    <th>Subject</th>
                    <th>Teacher</th>
                    <th>Status</th>
                `);
                $('#principalTimetableFilters').show();
                loadTimetableFilters();
            } else if (role === 'principal') {
                // Principal sees all classes with teacher info
                header.html(`
                    <th>Period</th>
                    <th>Time</th>
                    <th>Class</th>
                    <th>Subject</th>
                    <th>Teacher</th>
                    <th>Status</th>
                `);
                $('#principalTimetableFilters').show();
                loadTimetableFilters();
            } else {
                // Teacher sees personal schedule
                header.html(`
                    <th>Period</th>
                    <th>Time</th>
                    <th>Class</th>
                    <th>Subject</th>
                    <th>Status</th>
                `);
                $('#principalTimetableFilters').hide();
            }
        }

        async function loadTimetableFilters() {
            try {
                const response = await fetch(`${API_URL}?action=getTimetableFilters`);
                const result = await response.json();
                
                if (result.success) {
                    populateTimetableFilters(result.data);
                }
            } catch (error) {
                console.error('Failed to load timetable filters:', error);
            }
        }

        function populateTimetableFilters(data) {
            const teacherFilter = $('#timetableTeacherFilter');
            const classFilter = $('#timetableClassFilter');
            
            // Populate teacher filter
            teacherFilter.empty().append('<option value="">All Teachers</option>');
            if (data.teachers) {
                data.teachers.forEach(teacher => {
                    teacherFilter.append(`<option value="${teacher}">${teacher}</option>`);
                });
            }
            
            // Populate class filter
            classFilter.empty().append('<option value="">All Classes</option>');
            if (data.classes) {
                data.classes.forEach(cls => {
                    classFilter.append(`<option value="${cls}">${cls}</option>`);
                });
            }
        }

        function clearTimetableFilters() {
            $('#timetableTeacherFilter').val('');
            $('#timetableClassFilter').val('');
            loadTimetable();
        }

        async function loadTimetable() {
            const selectedDate = $('#timetableDate').val();
            const teacherFilter = $('#timetableTeacherFilter').val() || '';
            const classFilter = $('#timetableClassFilter').val() || '';
            
            console.log('Loading timetable for:', { 
                selectedDate, 
                teacherFilter, 
                classFilter, 
                userRole: currentUser.role,
                userEmail: currentUser.email 
            });
            
            try {
                let url = `${API_URL}?action=getTimetable&userEmail=${encodeURIComponent(currentUser.email)}&date=${selectedDate}&userRole=${encodeURIComponent(currentUser.role)}`;
                
                if (teacherFilter) url += `&teacherFilter=${encodeURIComponent(teacherFilter)}`;
                if (classFilter) url += `&classFilter=${encodeURIComponent(classFilter)}`;
                
                console.log('Fetching timetable from:', url);
                
                const response = await fetch(url);
                const result = await response.json();
                
                console.log('Timetable API response:', result);
                
                if (result.success) {
                    displayTimetable(result.data, selectedDate);
                } else {
                    console.error('Failed to load timetable:', result.message);
                    $('#timetableBody').html('<tr><td colspan="6" class="text-center text-danger">Failed to load timetable: ' + (result.message || 'Unknown error') + '</td></tr>');
                }
            } catch (error) {
                console.error('Timetable loading error:', error);
                $('#timetableBody').html('<tr><td colspan="6" class="text-center text-danger">Error loading timetable: ' + error.message + '</td></tr>');
            }
        }

        function displayTimetable(timetableData, selectedDate) {
            console.log('displayTimetable called with:', { 
                dataLength: timetableData ? timetableData.length : 0, 
                selectedDate, 
                currentUserRole: currentUser.role,
                sampleData: timetableData ? timetableData.slice(0, 2) : null
            });
            
            const tbody = $('#timetableBody');
            tbody.empty();
            
            if (!timetableData || timetableData.length === 0) {
                const colSpan = (currentUser.role === 'Headmaster' || currentUser.role === 'Class Teacher') ? '6' : '5';
                tbody.append(`<tr><td colspan="${colSpan}" class="text-center">No classes scheduled for this date</td></tr>`);
                return;
            }
            
            // Get the day of the week for the selected date
            const dateObj = new Date(selectedDate);
            const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
            
            let filteredData = timetableData;
            
            // Filter based on user role
            if (currentUser.role === 'Teacher') {
                // Teachers see only their own schedule
                filteredData = timetableData.filter(entry => 
                    entry.teacherName === currentUser.name && entry.day === dayName
                );
            } else {
                // Principal/Admin/Headmaster see all schedules, filtered by day
                filteredData = timetableData.filter(entry => entry.day === dayName);
            }
            
            if (filteredData.length === 0) {
                const colSpan = (currentUser.role === 'Headmaster' || currentUser.role === 'Class Teacher') ? '6' : '5';
                const message = currentUser.role === 'Teacher' ? 
                    'No classes scheduled for you on this date' : 
                    'No classes scheduled for this date';
                tbody.append(`<tr><td colspan="${colSpan}" class="text-center">${message}</td></tr>`);
                return;
            }
            
            // Sort by period number
            filteredData.sort((a, b) => a.period - b.period);
            
            filteredData.forEach(entry => {
                let row;
                
                if (currentUser.role === 'Headmaster' || currentUser.role === 'Class Teacher') {
                    // Headmaster/Class Teacher view with teacher column
                    const reportStatus = checkReportStatus(selectedDate, entry.period, entry.teacherName);
                    row = `
                        <tr>
                            <td><strong>Period ${entry.period}</strong></td>
                            <td>${entry.time || 'Time not set'}</td>
                            <td>${entry.class}</td>
                            <td>${entry.subject}</td>
                            <td>${entry.teacherName}</td>
                            <td>${reportStatus}</td>
                        </tr>
                    `;
                } else {
                    // Teacher view (personal schedule)
                    const reportStatus = checkReportStatus(selectedDate, entry.period);
                    row = `
                        <tr>
                            <td><strong>Period ${entry.period}</strong></td>
                            <td>${entry.time || 'Time not set'}</td>
                            <td>${entry.class}</td>
                            <td>${entry.subject}</td>
                            <td>${reportStatus}</td>
                        </tr>
                    `;
                }
                
                tbody.append(row);
            });
            
            // Update title
            $('#timetableTitle').text(`${dayName} Schedule - ${selectedDate}`);
        }

        function checkReportStatus(date, period, teacherName = null) {
            // This would check if a daily report has been submitted for this date/period
            // For Principal/Admin view, check for specific teacher
            // For Teacher view, check for current user
            const checkFor = teacherName || currentUser.name;
            
            // Placeholder implementation - in real scenario, check against daily reports data
            return '<span class="text-muted">Not reported</span>';
        }

        // Approval functions (Headmaster only)
        async function loadPendingApprovals() {
            try {
                const response = await fetch(`${API_URL}?action=getPendingApprovals`);
                const result = await response.json();
                
                if (result.success) {
                    displayPendingApprovals(result.data);
                } else {
                    console.error('Failed to load pending approvals:', result.message);
                }
            } catch (error) {
                console.error('Pending approvals loading error:', error);
            }
        }

        function displayPendingApprovals(schemes) {
            const tbody = $('#approvalTableBody');
            tbody.empty();
            
            if (schemes.length === 0) {
                tbody.append('<tr><td colspan="9" class="text-center">No pending approvals</td></tr>');
                return;
            }
            
            schemes.forEach(scheme => {
                const row = `
                    <tr>
                        <td>${scheme.date}</td>
                        <td>${scheme.schemeId}</td>
                        <td>${scheme.teacher}</td>
                        <td>${scheme.month || 'Not set'}</td>
                        <td>${scheme.class}</td>
                        <td>${scheme.subject}</td>
                        <td>${scheme.chapter}</td>
                        <td>${scheme.periods}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="openApprovalModal('${scheme.schemeId}')">
                                <i class="fas fa-check"></i> Review
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function openApprovalModal(schemeId) {
            currentSchemeId = schemeId;
            // Load scheme details and show modal
            $('#approvalModal').modal('show');
        }

        async function approveScheme() {
            if (!currentSchemeId) return;
            
            try {
                const params = new URLSearchParams({
                    action: 'updateSchemeStatus',
                    schemeId: currentSchemeId,
                    status: 'Approved',
                    reason: ''
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    $('#approvalModal').modal('hide');
                    loadPendingApprovals();
                    alert('Scheme approved successfully!');
                } else {
                    alert('Failed to approve scheme: ' + result.message);
                }
            } catch (error) {
                console.error('Approval error:', error);
                alert('Failed to approve scheme. Please try again.');
            }
        }

        async function rejectScheme() {
            if (!currentSchemeId) return;
            
            const reason = $('#rejectionReason').val();
            if (!reason.trim()) {
                alert('Please provide a reason for rejection.');
                return;
            }
            
            try {
                const params = new URLSearchParams({
                    action: 'updateSchemeStatus',
                    schemeId: currentSchemeId,
                    status: 'Rejected',
                    reason: reason
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    $('#approvalModal').modal('hide');
                    loadPendingApprovals();
                    alert('Scheme rejected successfully!');
                } else {
                    alert('Failed to reject scheme: ' + result.message);
                }
            } catch (error) {
                console.error('Rejection error:', error);
                alert('Failed to reject scheme. Please try again.');
            }
        }

        // Helper functions
        async function loadUserClasses() {
            const classes = currentUser.classes ? currentUser.classes.split(',') : [];
            const classSelect = $('#schemeClass');
            classSelect.empty().append('<option value="">Select Class</option>');
            
            classes.forEach(className => {
                if (className && className.trim() !== 'All') {
                    classSelect.append(`<option value="${className.trim()}">${className.trim()}</option>`);
                }
            });
        }

        async function loadUserSubjects() {
            const subjects = currentUser.subjects ? currentUser.subjects.split(',') : [];
            const subjectSelect = $('#schemeSubject, #lpSubject');
            subjectSelect.empty().append('<option value="">Select Subject</option>');
            
            subjects.forEach(subject => {
                if (subject && subject.trim() !== 'All') {
                    subjectSelect.append(`<option value="${subject.trim()}">${subject.trim()}</option>`);
                }
            });
        }

        async function loadLessonPlanUserData() {
            // Populate lesson plan class dropdown
            const classes = currentUser.classes ? currentUser.classes.split(',') : [];
            const lpClassSelect = $('#lpClass');
            lpClassSelect.empty().append('<option value="">Select Class</option>');
            
            classes.forEach(className => {
                if (className && className.trim() !== 'All') {
                    lpClassSelect.append(`<option value="${className.trim()}">${className.trim()}</option>`);
                }
            });
        }

        // Today's timetable for daily reports
        async function loadTodayTimetableForReports() {
            const today = new Date().toISOString().split('T')[0];
            const dayName = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            
            try {
                const response = await fetch(`${API_URL}?action=getTimetable&userEmail=${encodeURIComponent(currentUser.email)}&date=${today}`);
                const result = await response.json();
                
                if (result.success) {
                    // Filter for current teacher and today
                    todayTimetableData = result.data.filter(entry => 
                        entry.teacherName === currentUser.name && entry.day === dayName
                    );
                    
                    displayTodayTimetableInfo();
                    populatePeriodDropdown();
                } else {
                    console.error('Failed to load today\'s timetable:', result.message);
                }
            } catch (error) {
                console.error('Today\'s timetable loading error:', error);
            }
        }

        function displayTodayTimetableInfo() {
            const container = $('#todayTimetableInfo');
            
            if (todayTimetableData.length === 0) {
                container.html('<p class="text-muted">No classes scheduled for today</p>');
                return;
            }
            
            let html = '<div class="row">';
            todayTimetableData.forEach(entry => {
                html += `
                    <div class="col-md-4 mb-2">
                        <div class="card card-sm">
                            <div class="card-body p-2">
                                <h6 class="card-title mb-1">Period ${entry.period}</h6>
                                <p class="card-text mb-0">
                                    <strong>${entry.class}</strong> - ${entry.subject}<br>
                                    <small class="text-muted">${entry.time || 'Time not set'}</small>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.html(html);
        }

        function populatePeriodDropdown() {
            const periodSelect = $('#reportPeriod');
            periodSelect.empty().append('<option value="">Select Period</option>');
            
            todayTimetableData.forEach(entry => {
                periodSelect.append(`<option value="${entry.period}">Period ${entry.period} - ${entry.class} (${entry.subject})</option>`);
            });
        }

        function updateClassAndSubjectFromTimetable() {
            const selectedPeriod = $('#reportPeriod').val();
            
            if (!selectedPeriod) {
                $('#reportClass').val('');
                $('#reportSubject').val('');
                $('#reportLessonPlan').empty().append('<option value="">First select period</option>');
                return;
            }
            
            const timetableEntry = todayTimetableData.find(entry => entry.period.toString() === selectedPeriod);
            
            if (timetableEntry) {
                $('#reportClass').val(timetableEntry.class);
                $('#reportSubject').val(timetableEntry.subject);
                
                // Load lesson plans for this class and subject
                loadLessonPlansForReport(timetableEntry.class, timetableEntry.subject);
            }
        }

        async function loadLessonPlansForReport(className, subject) {
            try {
                const params = new URLSearchParams({
                    action: 'getLessonPlans',
                    teacher: currentUser.name,
                    class: className,
                    subject: subject,
                    status: 'Approved'
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    const reportLessonPlanSelect = $('#reportLessonPlan');
                    reportLessonPlanSelect.empty()
                        .append('<option value="">Select Lesson Plan</option>')
                        .append('<option value="no-plan">No Plan (Direct Teaching)</option>');
                    
                    // Filter to only show approved lesson plans for this class and subject
                    const filteredLessonPlans = result.data.filter(lp => 
                        lp.Status === 'Approved' && 
                        lp.Class === className && 
                        lp.Subject === subject
                    );
                    
                    filteredLessonPlans.forEach(lp => {
                        const displayText = `${lp.LPID} - ${lp.ChapterName}`;
                        reportLessonPlanSelect.append(`<option value="${lp.LPID}">${displayText}</option>`);
                    });
                    
                    if (filteredLessonPlans.length === 0) {
                        reportLessonPlanSelect.append('<option value="" disabled>No approved lesson plans available for this class/subject</option>');
                    }
                } else {
                    console.error('Failed to load lesson plans for report:', result.message);
                }
            } catch (error) {
                console.error('Error loading lesson plans for report:', error);
            }
        }

        function autoFillLessonPlanDetails() {
            const selectedLessonPlanId = $('#reportLessonPlan').val();
            
            if (!selectedLessonPlanId || selectedLessonPlanId === 'no-plan') {
                $('#reportObjectives').val('');
                $('#reportActivities').val('');
                $('#reportChapter').val('');
                return;
            }
            
            // Find the lesson plan in our stored data
            const lessonPlan = lessonPlansData.find(lp => lp.LPID === selectedLessonPlanId);
            
            if (lessonPlan) {
                $('#reportObjectives').val(lessonPlan.Objectives || '');
                $('#reportActivities').val(lessonPlan.Activities || '');
                $('#reportChapter').val(lessonPlan.ChapterName || '');
            }
        }

        // New lesson plan view and approval functions
        function viewLessonPlanForApproval(lessonPlanId) {
            const lessonPlan = lessonPlansData.find(lp => lp.LPID === lessonPlanId);
            
            if (!lessonPlan) {
                alert('Lesson plan not found');
                return;
            }
            
            // Display lesson plan details in view modal
            const detailsHtml = `
                <div class="card">
                    <div class="card-body">
                        <h6><strong>Lesson Plan ID:</strong> ${lessonPlan.LPID}</h6>
                        <p><strong>Scheme ID:</strong> ${lessonPlan.SchemeID || 'N/A'}</p>
                        <p><strong>Teacher:</strong> ${lessonPlan.Teacher || currentUser.name}</p>
                        <p><strong>Class:</strong> ${lessonPlan.Class}</p>
                        <p><strong>Subject:</strong> ${lessonPlan.Subject}</p>
                        <p><strong>Chapter:</strong> ${lessonPlan.ChapterName}</p>
                        <p><strong>Period:</strong> ${lessonPlan.Period ? `Period ${lessonPlan.Period}` : 'Not Set'}</p>
                        
                        <hr>
                        
                        <h6><strong>Learning Objectives:</strong></h6>
                        <div class="border p-2 mb-3" style="background-color: #f8f9fa;">
                            ${lessonPlan.Objectives || 'Not specified'}
                        </div>
                        
                        <h6><strong>Planned Activities:</strong></h6>
                        <div class="border p-2" style="background-color: #f8f9fa;">
                            ${lessonPlan.Activities || 'Not specified'}
                        </div>
                    </div>
                </div>
            `;
            
            $('#viewLessonPlanDetails').html(detailsHtml);
            
            // Add action buttons for Headmaster
            const actionButtonsHtml = `
                <button type="button" class="btn btn-success" onclick="showApprovalModal('${lessonPlanId}', 'approve')">
                    <i class="fas fa-check"></i> Approve
                </button>
                <button type="button" class="btn btn-warning" onclick="showApprovalModal('${lessonPlanId}', 'rework')">
                    <i class="fas fa-edit"></i> Needs Rework
                </button>
                <button type="button" class="btn btn-danger" onclick="showApprovalModal('${lessonPlanId}', 'reject')">
                    <i class="fas fa-times"></i> Reject
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            `;
            
            $('#lessonPlanViewActions').html(actionButtonsHtml);
            $('#lessonPlanViewModal').modal('show');
        }

        function showApprovalModal(lessonPlanId, action) {
            currentLessonPlanId = lessonPlanId;
            $('#lessonPlanViewModal').modal('hide');
            
            const lessonPlan = lessonPlansData.find(lp => lp.LPID === lessonPlanId);
            
            // Show summary in approval modal
            $('#approvalLessonPlanDetails').html(`
                <div class="alert alert-info">
                    <strong>Action:</strong> ${action.charAt(0).toUpperCase() + action.slice(1)} lesson plan ${lessonPlanId}<br>
                    <strong>Class:</strong> ${lessonPlan.Class} | <strong>Subject:</strong> ${lessonPlan.Subject}
                </div>
            `);
            
            // Set appropriate placeholder text
            const reasonField = $('#lessonPlanActionReason');
            if (action === 'approve') {
                reasonField.attr('placeholder', 'Optional comments...');
            } else if (action === 'rework') {
                reasonField.attr('placeholder', 'Specify what needs to be reworked...');
            } else {
                reasonField.attr('placeholder', 'Specify reason for rejection...');
            }
            
            $('#lessonPlanApprovalModal').modal('show');
        }

        async function needsReworkLessonPlan() {
            if (!currentLessonPlanId) return;
            
            const reason = $('#lessonPlanActionReason').val();
            if (!reason.trim()) {
                alert('Please provide details about what needs to be reworked.');
                return;
            }
            
            try {
                const params = new URLSearchParams({
                    action: 'updateLessonPlanStatus',
                    lessonPlanId: currentLessonPlanId,
                    status: 'Needs Rework',
                    reason: reason
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    $('#lessonPlanApprovalModal').modal('hide');
                    loadLessonPlans();
                    alert('Lesson plan marked for rework successfully!');
                } else {
                    alert('Failed to mark lesson plan for rework: ' + result.message);
                }
            } catch (error) {
                console.error('Lesson plan rework error:', error);
                alert('Failed to mark lesson plan for rework. Please try again.');
            }
        }

        function showMessage(elementId, message, type) {
            const element = $('#' + elementId);
            element.removeClass('alert-success alert-danger alert-warning alert-info')
                   .addClass(`alert-${type}`)
                   .text(message)
                   .show();
            
            setTimeout(() => {
                element.hide();
            }, 5000);
        }

        function showError(elementId, message) {
            showMessage(elementId, message, 'danger');
        }

        // View details functions (to be implemented)
        function viewSchemeDetails(schemeId) {
            console.log('View scheme details:', schemeId);
            // Implementation for viewing scheme details
        }

        function viewLessonPlanDetails(lessonPlanId) {
            console.log('View lesson plan details:', lessonPlanId);
            // Implementation for viewing lesson plan details
        }

        function viewReportDetails(reportId) {
            console.log('View report details:', reportId);
            // Implementation for viewing report details
        }

        // Lesson Plan Approval functions
        async function loadPendingLessonPlanApprovals() {
            try {
                const response = await fetch(`${API_URL}?action=getPendingLessonPlanApprovals`);
                const result = await response.json();
                
                if (result.success) {
                    displayPendingLessonPlanApprovals(result.data);
                } else {
                    console.error('Failed to load pending lesson plan approvals:', result.message);
                }
            } catch (error) {
                console.error('Pending lesson plan approvals loading error:', error);
            }
        }

        function displayPendingLessonPlanApprovals(lessonPlans) {
            const tbody = $('#lessonPlanApprovalTableBody');
            tbody.empty();
            
            if (lessonPlans.length === 0) {
                tbody.append('<tr><td colspan="9" class="text-center">No pending lesson plan approvals</td></tr>');
                return;
            }
            
            lessonPlans.forEach(lp => {
                const row = `
                    <tr>
                        <td>${lp.lessonPlanId}</td>
                        <td>${lp.schemeId}</td>
                        <td>${lp.teacher}</td>
                        <td>${lp.month || 'Not set'}</td>
                        <td>${lp.class}</td>
                        <td>${lp.subject}</td>
                        <td>${lp.chapter}</td>
                        <td>${lp.period}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="openLessonPlanApprovalModal('${lp.lessonPlanId}')">
                                <i class="fas fa-check"></i> Review
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        async function openLessonPlanApprovalModal(lessonPlanId) {
            currentLessonPlanId = lessonPlanId;
            
            try {
                // Load full lesson plan details including objectives and activities
                const response = await fetch(`${API_URL}?action=getLessonPlanDetails&lessonPlanId=${encodeURIComponent(lessonPlanId)}`);
                const result = await response.json();
                
                if (result.success) {
                    const lp = result.data;
                    
                    // Display basic details
                    $('#approvalLessonPlanDetails').html(`
                        <div class="alert alert-info">
                            <h6>Lesson Plan Details:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>LP ID:</strong> ${lp.lessonPlanId}</p>
                                    <p><strong>Scheme ID:</strong> ${lp.schemeId}</p>
                                    <p><strong>Teacher:</strong> ${lp.teacher}</p>
                                    <p><strong>Month:</strong> ${lp.month || 'Not set'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Class:</strong> ${lp.class}</p>
                                    <p><strong>Subject:</strong> ${lp.subject}</p>
                                    <p><strong>Chapter:</strong> ${lp.chapter}</p>
                                    <p><strong>Period:</strong> ${lp.period}</p>
                                </div>
                            </div>
                        </div>
                    `);
                    
                    // Display objectives and activities
                    $('#lessonPlanObjectives').html(lp.objectives || '<em class="text-muted">No objectives provided</em>');
                    $('#lessonPlanActivities').html(lp.activities || '<em class="text-muted">No activities provided</em>');
                    
                } else {
                    $('#approvalLessonPlanDetails').html('<div class="alert alert-danger">Failed to load lesson plan details</div>');
                    $('#lessonPlanObjectives').html('<em class="text-muted">Failed to load</em>');
                    $('#lessonPlanActivities').html('<em class="text-muted">Failed to load</em>');
                }
            } catch (error) {
                console.error('Error loading lesson plan details:', error);
                $('#approvalLessonPlanDetails').html('<div class="alert alert-danger">Error loading lesson plan details</div>');
            }
            
            $('#lessonPlanApprovalModal').modal('show');
        }

        // Direct approval function for Headmaster (legacy - still used in some contexts)
        async function approveLessonPlan(lessonPlanId) {
            if (!lessonPlanId) return;
            
            if (!confirm('Are you sure you want to approve this lesson plan?')) return;
            
            try {
                const params = new URLSearchParams({
                    action: 'updateLessonPlanStatus',
                    lessonPlanId: lessonPlanId,
                    status: 'Approved',
                    reason: ''
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    loadLessonPlans();
                    alert('Lesson plan approved successfully!');
                } else {
                    alert('Failed to approve lesson plan: ' + result.message);
                }
            } catch (error) {
                console.error('Lesson plan approval error:', error);
                alert('Failed to approve lesson plan. Please try again.');
            }
        }

        // Direct rejection function for Headmaster (legacy - still used in some contexts)
        async function rejectLessonPlan(lessonPlanId) {
            if (!lessonPlanId) return;
            
            const reason = prompt('Please enter the reason for rejection:');
            if (!reason) return;
            
            try {
                const params = new URLSearchParams({
                    action: 'updateLessonPlanStatus',
                    lessonPlanId: lessonPlanId,
                    status: 'Rejected',
                    reason: reason
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    loadLessonPlans();
                    alert('Lesson plan rejected successfully!');
                } else {
                    alert('Failed to reject lesson plan: ' + result.message);
                }
            } catch (error) {
                console.error('Lesson plan rejection error:', error);
                alert('Failed to reject lesson plan. Please try again.');
            }
        }

        // Legacy approval function (keep for modal-based approval)
        async function approveLessonPlanFromModal() {
            if (!currentLessonPlanId) return;
            
            const reason = $('#lessonPlanActionReason').val();
            
            try {
                const params = new URLSearchParams({
                    action: 'updateLessonPlanStatus',
                    lessonPlanId: currentLessonPlanId,
                    status: 'Approved',
                    reason: reason || ''
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    $('#lessonPlanApprovalModal').modal('hide');
                    loadLessonPlans();
                    alert('Lesson plan approved successfully!');
                } else {
                    alert('Failed to approve lesson plan: ' + result.message);
                }
            } catch (error) {
                console.error('Lesson plan approval error:', error);
                alert('Failed to approve lesson plan. Please try again.');
            }
        }

        // Legacy rejection function (keep for modal-based rejection) 
        async function rejectLessonPlanFromModal() {
            if (!currentLessonPlanId) return;
            
            const reason = $('#lessonPlanActionReason').val();
            if (!reason.trim()) {
                alert('Please provide a reason for rejection.');
                return;
            }
            
            try {
                const params = new URLSearchParams({
                    action: 'updateLessonPlanStatus',
                    lessonPlanId: currentLessonPlanId,
                    status: 'Rejected',
                    reason: reason
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    $('#lessonPlanApprovalModal').modal('hide');
                    loadLessonPlans();
                    alert('Lesson plan rejected successfully!');
                } else {
                    alert('Failed to reject lesson plan: ' + result.message);
                }
            } catch (error) {
                console.error('Lesson plan rejection error:', error);
                alert('Failed to reject lesson plan. Please try again.');
            }
        }

        // Lesson Plan Completion functions
        function openLessonPlanCompletionModal(lessonPlanId, chapter, className, subject, period) {
            currentCompletionLessonPlanId = lessonPlanId;
            
            // Show lesson plan details
            $('#completionLessonPlanDetails').html(`
                <div class="alert alert-info">
                    <h6>Lesson Plan Details:</h6>
                    <p><strong>Lesson Plan ID:</strong> ${lessonPlanId}</p>
                    <p><strong>Class:</strong> ${className}</p>
                    <p><strong>Subject:</strong> ${subject}</p>
                    <p><strong>Chapter:</strong> ${chapter}</p>
                    ${period ? `<p><strong>Period:</strong> ${period}</p>` : ''}
                </div>
            `);
            
            // Reset form
            $('#lessonPlanCompletionForm')[0].reset();
            
            // Pre-fill period if available
            if (period) {
                $('#completionPeriod').val(period);
                // If period is already set, make it readonly and hide the dropdown
                $('#completionPeriod').prop('readonly', true).closest('.form-group').hide();
            } else {
                $('#completionPeriod').prop('readonly', false).closest('.form-group').show();
            }
            
            // Show modal
            $('#lessonPlanCompletionModal').modal('show');
        }

        async function submitLessonPlanCompletion() {
            if (!currentCompletionLessonPlanId) return;
            
            const period = $('#completionPeriod').val();
            const objectives = $('#completionObjectives').val();
            const activities = $('#completionActivities').val();
            
            // Period is optional if already set during auto-generation
            if (!objectives.trim() || !activities.trim()) {
                alert('Please fill in Learning Objectives and Planned Activities.');
                return;
            }
            
            try {
                const params = new URLSearchParams({
                    action: 'completeLessonPlan',
                    lessonPlanId: currentCompletionLessonPlanId,
                    objectives: objectives,
                    activities: activities
                });
                
                // Only include period if it's provided (might already be set)
                if (period) {
                    params.append('period', period);
                }
                
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    $('#lessonPlanCompletionModal').modal('hide');
                    loadLessonPlans();
                    alert('Lesson plan completed successfully! Status changed to Pending for approval.');
                } else {
                    alert('Failed to complete lesson plan: ' + result.message);
                }
            } catch (error) {
                console.error('Lesson plan completion error:', error);
                alert('Failed to complete lesson plan. Please try again.');
            }
        }

        // Debug function to get sheet headers
        async function getSheetHeaders() {
            try {
                const response = await fetch(`${API_URL}?action=testUsers`);
                const result = await response.json();
                
                console.log('=== SHEET HEADERS INFORMATION ===');
                if (result.success && result.data) {
                    console.log('Spreadsheet Name:', result.data.spreadsheetName);
                    console.log('Spreadsheet ID:', result.data.spreadsheetId);
                    console.log('Total Sheets:', result.data.totalSheets);
                    console.log('\n=== ALL SHEETS ===');
                    
                    Object.entries(result.data.sheets).forEach(([sheetName, info]) => {
                        console.log(`\n--- ${sheetName} ---`);
                        if (info.error) {
                            console.log('ERROR:', info.error);
                        } else if (info.note) {
                            console.log('NOTE:', info.note);
                        } else {
                            console.log('Headers:', info.headers);
                            console.log('Total Rows:', info.totalRows);
                            console.log('Total Columns:', info.totalColumns);
                            if (info.sampleData && info.sampleData.length > 0) {
                                console.log('Sample Data (first 3 rows):', info.sampleData);
                            }
                        }
                    });
                    
                    console.log('\n=== EXPECTED SHEETS ===');
                    console.log('Expected:', result.data.expectedSheets);
                    
                    // Check for missing sheets
                    const expectedSheetNames = Object.values(result.data.expectedSheets || {});
                    const actualSheetNames = Object.keys(result.data.sheets);
                    const missingSheets = expectedSheetNames.filter(name => !actualSheetNames.includes(name));
                    
                    if (missingSheets.length > 0) {
                        console.log('\n=== MISSING SHEETS ===');
                        console.log('Missing:', missingSheets);
                    }
                } else {
                    console.error('Failed to get sheet headers:', result.message || result.error);
                }
                
                return result;
            } catch (error) {
                console.error('Error calling getSheetHeaders:', error);
            }
        }

        // Make function available globally for console access
        window.getSheetHeaders = getSheetHeaders;
    </script>
</body>
</html>
